<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html height="100%">
<head>
    <title>Fetch Data From ThingSpeak</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script type="text/javascript">
        // Arrays to store the last 10 values
        let temperatureValues = [];
        let humidityValues = [];
        let pressureValues = [];
        let moistureValues = [];
        let lightIntensityValues = [];

        $(document).ready(function () {
            console.log("Document is ready, initiating data fetch.");
            GetData();
        });

        function GetData() {
            console.log("Fetching data from ThingSpeak...");
            var url = 'https://api.thingspeak.com/channels/2364561/feeds.json?results=1';

            $.ajax({
                url: url,
                type: 'GET',
                contentType: "application/json",
                success: function (data, textStatus, xhr) {
                    console.log("Data fetched successfully:", data);

                    // Process the latest feed data
                    var latestFeed = data.feeds[data.feeds.length - 1];

                    // Update real-time values
                    updateField('#txtField1', latestFeed.field1, temperatureValues);
                    updateField('#txtField2', latestFeed.field2, humidityValues);
                    updateField('#txtField3', latestFeed.field3, pressureValues);
                    updateField('#txtField4', latestFeed.field4, moistureValues);
                    updateField('#txtField5', latestFeed.field5, lightIntensityValues);

                    // Update average values
                    $('#avgField1').val(calculateAverage(temperatureValues));
                    $('#avgField2').val(calculateAverage(humidityValues));
                    $('#avgField3').val(calculateAverage(pressureValues));
                    $('#avgField4').val(calculateAverage(moistureValues));
                    $('#avgField5').val(calculateAverage(lightIntensityValues));
                },
                error: function (xhr, textStatus, errorThrown) {
                    console.error("Error fetching data:", errorThrown);
                }
            });

            setTimeout(GetData, 10000); // Repeat every 10 seconds
        }

        // Function to update field value and keep only the last 10 values
        function updateField(selector, value, valueArray) {
            $(selector).val(value); // Update the real-time value

            // Convert value to float and add to array
            let numericValue = parseFloat(value);
            if (!isNaN(numericValue)) {
                valueArray.push(numericValue);
                if (valueArray.length > 10) {
                    valueArray.shift(); // Remove the oldest value if array exceeds 10 values
                }
            }
        }

        // Function to calculate the average of an array
        function calculateAverage(array) {
            if (array.length === 0) return '';
            let sum = array.reduce((acc, val) => acc + val, 0);
            return (sum / array.length).toFixed(2);
        }
    </script>
</head>
<body height="100%">
    <table width="100%" height="100%" border="1" class="MGVTable">
        <tr height="5%">
            <td style="background: #F0F0F0">
                Data fetched from ThingSpeak every 10 seconds
            </td>
        </tr>
        <tr height="95%">
            <td>
                <table width="100%" height="100%" border="1" style="border-collapse: collapse; border: 1px solid #CDCDCD;">
                    <tr>
                        <td width="20%" valign="top"></td>
                        <td width="80%" valign="top">
                            <table>
                                <tr>
                                    <td>Temperature:</td>
                                    <td>Real-time: <input id="txtField1" type="text" /></td>
                                    <td>Average: <input id="avgField1" type="text" /></td>
                                </tr>
                                <tr>
                                    <td>Humidity:</td>
                                    <td>Real-time: <input id="txtField2" type="text" /></td>
                                    <td>Average: <input id="avgField2" type="text" /></td>
                                </tr>
                                <tr>
                                    <td>Pressure:</td>
                                    <td>Real-time: <input id="txtField3" type="text" /></td>
                                    <td>Average: <input id="avgField3" type="text" /></td>
                                </tr>
                                <tr>
                                    <td>Moisture:</td>
                                    <td>Real-time: <input id="txtField4" type="text" /></td>
                                    <td>Average: <input id="avgField4" type="text" /></td>
                                </tr>
                                <tr>
                                    <td>Light Intensity:</td>
                                    <td>Real-time: <input id="txtField5" type="text" /></td>
                                    <td>Average: <input id="avgField5" type="text" /></td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                </table>
            </td>
        </tr>
    </table>
</body>
</html>
